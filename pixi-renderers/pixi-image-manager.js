var gdjs;(function(g){const u=new g.Logger("PIXI Image manager"),l=GlobalPIXIModule.PIXI,h=(a,e)=>{u.error("Unable to load file "+a+" with error:",e||"(unknown error)")},x=(a,e)=>{!a||e.smoothed||(a.baseTexture.scaleMode=l.SCALE_MODES.NEAREST)},R=(a,e)=>{e&&!e.smoothed&&(a.magFilter=THREE.NearestFilter,a.minFilter=THREE.NearestFilter)},T=(a,e,r)=>{const t=a.get(e);return t&&t.kind===r?t:null};class _{constructor(e,r){this._resources=new Map,this.setResources(e),this._resourcesLoader=r,this._invalidTexture=l.Texture.from("data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAgAAAAICAYAAADED76LAAAAFElEQVQoU2P8z/D/PwMewDgyFAAApMMX8Zi0uXAAAAAASUVORK5CYIIA"),this._loadedTextures=new Hashtable,this._loadedThreeTextures=new Hashtable,this._loadedThreeMaterials=new Hashtable}setResources(e){this._resources.clear();for(const r of e)r.kind==="image"&&this._resources.set(r.name,r)}getPIXITexture(e){if(this._loadedTextures.containsKey(e)){const s=this._loadedTextures.get(e);if(s.valid)return s;u.error("Texture for "+e+" is not valid anymore (or never was).")}if(e==="")return this._invalidTexture;const r=T(this._resources,e,"image");if(!r)return u.warn('Unable to find texture for resource "'+e+'".'),this._invalidTexture;u.log('Loading texture for resource "'+e+'"...');const t=r.file,i=l.Texture.from(this._resourcesLoader.getFullUrl(t),{resourceOptions:{crossorigin:this._resourcesLoader.checkIfCredentialsRequired(t)?"use-credentials":"anonymous"}}).on("error",s=>{h(t,s)});return x(i,r),this._loadedTextures.put(e,i),i}getThreeTexture(e){const r=this._loadedThreeTextures.get(e);if(r)return r;const t=this.getPIXITexture(e);if(!this._resourcesLoader._runtimeGame.getRenderer().getPIXIRenderer())throw new Error("No PIXI renderer was found.");const s=t.baseTexture.resource.source;if(!(s instanceof HTMLImageElement))throw new Error(`Can't load texture for resource "${e}" as it's not an image.`);const n=new THREE.Texture(s);n.magFilter=THREE.LinearFilter,n.minFilter=THREE.LinearFilter,n.wrapS=THREE.RepeatWrapping,n.wrapT=THREE.RepeatWrapping,n.colorSpace=THREE.SRGBColorSpace,n.needsUpdate=!0;const o=T(this._resources,e,"image");return R(n,o),this._loadedThreeTextures.put(e,n),n}getThreeMaterial(e,{useTransparentTexture:r,forceBasicMaterial:t}){const i=`${e}|${r?1:0}|${t?1:0}`,s=this._loadedThreeMaterials.get(i);if(s)return s;const n=t?new THREE.MeshBasicMaterial({map:this.getThreeTexture(e),side:r?THREE.DoubleSide:THREE.FrontSide,transparent:r}):new THREE.MeshStandardMaterial({map:this.getThreeTexture(e),side:r?THREE.DoubleSide:THREE.FrontSide,transparent:r,metalness:0});return this._loadedThreeMaterials.put(i,n),n}getPIXIVideoTexture(e){if(this._loadedTextures.containsKey(e))return this._loadedTextures.get(e);if(e==="")return this._invalidTexture;const r=T(this._resources,e,"video");if(!r)return u.warn('Unable to find video texture for resource "'+e+'".'),this._invalidTexture;const t=r.file;u.log('Loading video texture for resource "'+e+'"...');const i=l.Texture.from(this._resourcesLoader.getFullUrl(t),{resourceOptions:{crossorigin:this._resourcesLoader.checkIfCredentialsRequired(t)?"use-credentials":"anonymous"}}).on("error",s=>{h(t,s)});return this._loadedTextures.put(e,i),i}getInvalidPIXITexture(){return this._invalidTexture}loadTextures(e){const r={};for(const o of this._resources.values())if(o.file){if(this._loadedTextures.containsKey(o.name))continue;r[o.file]=r[o.file]?r[o.file].concat(o):[o]}const t=Object.keys(r).length;if(t===0)return Promise.resolve(0);const i=l.Loader.shared;let s=0;const n=i.onProgress.add(function(){s++,e(s,t)});for(const o in r)r.hasOwnProperty(o)&&i.add({name:o,url:this._resourcesLoader.getFullUrl(o),loadType:l.LoaderResource.LOAD_TYPE.IMAGE,crossOrigin:this._resourcesLoader.checkIfCredentialsRequired(o)?"use-credentials":"anonymous"});return new Promise((o,m)=>{i.load((p,c)=>{p.onProgress.detach(n);for(const d in c)if(c.hasOwnProperty(d)){if(!r.hasOwnProperty(d))continue;r[d].forEach(E=>{const f=c[d].texture;if(!f){const I=c[d].error;h(d,I);return}this._loadedTextures.put(E.name,f),x(f,E)})}o(t)})})}}g.PixiImageManager=_,g.ImageManager=g.PixiImageManager})(gdjs||(gdjs={}));
//# sourceMappingURL=pixi-image-manager.js.map
